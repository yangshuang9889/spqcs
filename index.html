<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ·»åŠ å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¬</text></svg>" type="image/svg+xml">
    <title>ç«–ç‰ˆè§†é¢‘å¢™</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="stars" id="stars"></div>
    <h1 style="text-align: center; margin: 20px 0;">è§†é¢‘å¢™</h1>
    <div id="videoCount" style="text-align: center; color: #fff; margin-bottom: 20px;">
        å·²åŠ è½½: <span id="currentCount">0</span> / <span id="totalCount">åŠ è½½ä¸­...</span>
    </div>
    <div class="video-container" id="videoContainer">
        <!-- è§†é¢‘å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <script>
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'VIDEO') {
                console.log('è§†é¢‘åŠ è½½é”™è¯¯:', e);
                const videoCard = e.target.closest('.video-card');
                if (videoCard) {
                    videoCard.classList.remove('loading');
                }
            }
        }, true);

        function createVideoCard(videoNumber) {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card loading';
            
            const video = document.createElement('video');
            video.src = `sp/${videoNumber}.mp4`;
            video.loop = true;
            video.preload = 'metadata';
            video.setAttribute('playsinline', '');
            video.muted = true;
            
            video.addEventListener('loadeddata', () => {
                video.classList.add('loaded');
                videoCard.classList.remove('loading');
            });
            
            videoCard.appendChild(video);
            
            let isPlaying = false;
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœæ’­æ”¾
            videoCard.addEventListener('mouseenter', () => {
                if (!isPlaying) {
                    video.muted = true;
                    video.play();
                }
            });
            
            videoCard.addEventListener('mouseleave', () => {
                if (!isPlaying) {
                    video.pause();
                    video.currentTime = 0;
                }
            });
            
            // ç‚¹å‡»è§†é¢‘æ’­æ”¾æˆ–å…³é—­
            videoCard.addEventListener('click', async (e) => {
                e.stopPropagation();
                const footer = document.querySelector('footer');
                
                if (!isPlaying && !document.body.classList.contains('video-playing')) {
                    try {
                        // æ‰“å¼€è§†é¢‘å‰éšè—é¡µè„š
                        footer.style.display = 'none';
                        
                        await video.load();
                        video.muted = false;
                        video.volume = 1.0;
                        
                        videoCard.classList.add('playing');
                        document.body.classList.add('video-playing');
                        isPlaying = true;
                        
                        await video.play();
                    } catch (error) {
                        console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
                    }
                } else if (isPlaying) {
                    // å…³é—­è§†é¢‘æ—¶æ˜¾ç¤ºé¡µè„š
                    video.muted = true;
                    video.pause();
                    video.currentTime = 0;
                    
                    videoCard.classList.remove('playing');
                    document.body.classList.remove('video-playing');
                    isPlaying = false;
                    
                    footer.style.display = 'block';
                }
            });
            
            // æ·»åŠ é”®ç›˜ESCå…³é—­åŠŸèƒ½
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isPlaying) {
                    const footer = document.querySelector('footer');
                    video.muted = true;
                    video.pause();
                    video.currentTime = 0;
                    
                    videoCard.classList.remove('playing');
                    document.body.classList.remove('video-playing');
                    isPlaying = false;
                    
                    footer.style.display = 'block';
                }
            });
            
            return videoCard;
        }

        function loadVideos() {
            const videoContainer = document.getElementById('videoContainer');
            const currentCountElement = document.getElementById('currentCount');
            const totalCountElement = document.getElementById('totalCount');
            
            let loadedCount = 0;
            let isLoading = true;
            let totalVideos = 0;
            let validVideos = []; // å­˜å‚¨æœ‰æ•ˆçš„è§†é¢‘ç¼–å·
            
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            function updateLoadingText() {
                const dots = ['', '.', '..', '...'];
                let index = 0;
                
                const loadingElement = document.createElement('div');
                loadingElement.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 18px;
                    z-index: 2001;
                `;
                document.body.appendChild(loadingElement);
                
                const loadingInterval = setInterval(() => {
                    loadingElement.textContent = `æ£€æµ‹è§†é¢‘ä¸­${dots[index]}`;
                    index = (index + 1) % dots.length;
                }, 500);
                
                return {
                    element: loadingElement,
                    interval: loadingInterval
                };
            }
            
            // æ£€æŸ¥è§†é¢‘æ˜¯å¦å­˜åœ¨
            function checkVideo(number) {
                return new Promise((resolve) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('HEAD', `sp/${number}.mp4`, true);
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            validVideos.push(number);
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    };
                    
                    xhr.onerror = () => {
                        resolve(false);
                    };
                    
                    xhr.send();
                    
                    // è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
                    setTimeout(() => {
                        xhr.abort();
                        resolve(false);
                    }, 1000);
                });
            }
            
            // è·å–å®é™…è§†é¢‘æ€»æ•°
            async function getTotalVideos() {
                let consecutiveFailures = 0;
                const maxConsecutiveFailures = 3;
                let number = 1;
                
                while (consecutiveFailures < maxConsecutiveFailures) {
                    if (await checkVideo(number)) {
                        consecutiveFailures = 0;
                        number++;
                    } else {
                        consecutiveFailures++;
                    }
                }
                
                return validVideos.length; // è¿”å›å®é™…æœ‰çš„è§†é¢‘æ•°é‡
            }
            
            // åˆ†æ‰¹åŠ è½½è§†é¢‘
            async function loadVideoBatch(videos, batchSize = 10) {
                for (let i = 0; i < videos.length; i += batchSize) {
                    const batch = videos.slice(i, i + batchSize);
                    await Promise.all(batch.map(num => loadVideo(num)));
                    await new Promise(resolve => setTimeout(resolve, 100)); // æ‰¹æ¬¡é—´éš”
                }
            }
            
            // åŠ è½½è§†é¢‘
            async function loadVideo(number) {
                if (validVideos.includes(number)) {
                    try {
                        const videoCard = createVideoCard(number);
                        const video = videoCard.querySelector('video');
                        
                        // æ·»åŠ åŠ è½½é”™è¯¯å¤„ç†
                        video.onerror = async function() {
                            console.log(`è§†é¢‘ ${number} åŠ è½½å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½...`);
                            // æœ€å¤šé‡è¯•3æ¬¡
                            for (let i = 0; i < 3; i++) {
                                try {
                                    await new Promise((resolve, reject) => {
                                        video.src = `sp/${number}.mp4?retry=${i}`;
                                        video.onloadeddata = resolve;
                                        video.onerror = reject;
                                    });
                                    break; // å¦‚æœæˆåŠŸåŠ è½½ï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                                } catch (e) {
                                    console.log(`ç¬¬ ${i + 1} æ¬¡é‡è¯•å¤±è´¥`);
                                    if (i === 2) {
                                        videoCard.innerHTML = `<div class="error-message">è§†é¢‘ ${number} åŠ è½½å¤±è´¥</div>`;
                                    }
                                }
                            }
                        };
                        
                        videoContainer.appendChild(videoCard);
                        loadedCount++;
                        currentCountElement.textContent = loadedCount;
                        return true;
                    } catch (error) {
                        console.error('åŠ è½½è§†é¢‘å¤±è´¥:', error);
                    }
                }
                return false;
            }
            
            // åˆå§‹åŒ–åŠ è½½
            async function initialize() {
                const loading = updateLoadingText();
                totalCountElement.textContent = "æ£€æµ‹ä¸­...";
                
                totalVideos = await getTotalVideos();
                clearInterval(loading.interval);
                loading.element.remove();
                
                totalCountElement.textContent = totalVideos;
                
                // ä½¿ç”¨åˆ†æ‰¹åŠ è½½
                await loadVideoBatch(validVideos);
                showLoadingComplete();
            }
            
            // æ˜¾ç¤ºåŠ è½½å®Œæˆæç¤º
            function showLoadingComplete() {
                isLoading = false;
                const message = document.createElement('div');
                message.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 2001;
                `;
                message.textContent = `å·²åŠ è½½è§†é¢‘ï¼š${loadedCount}/${totalVideos}`;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 3000);
            }
            
            // å¼€å§‹åˆå§‹åŒ–
            initialize();
        }

        // æ·»åŠ çª—å£å¤§å°æ”¹å˜çš„å¤„ç†
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // é‡æ–°è®¡ç®—ç½‘æ ¼å¸ƒå±€
                const container = document.querySelector('.video-container');
                if (window.innerWidth <= 767) {
                    container.style.gridTemplateColumns = 'repeat(2, 1fr)';
                } else if (window.innerWidth <= 1023) {
                    container.style.gridTemplateColumns = 'repeat(3, 1fr)';
                } else {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                }
            }, 250);
        });

        // ç”Ÿæˆæ˜Ÿæ˜Ÿ
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numberOfStars = 150; // å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡
            
            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // éšæœºä½ç½®
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // å¢æ˜Ÿå¤§å°èŒƒå›´
                const size = 1 + Math.random() * 3; // æœ€å°1pxï¼Œæœ€å¤§4px
                
                // éšæœºåŠ¨ç”»æŒç»­æ—¶é—´
                const duration = 3 + Math.random() * 4;
                
                // éšæœºåˆå§‹é€æ˜åº¦
                const initialOpacity = 0.3 + Math.random() * 0.7;
                
                star.style.cssText = `
                    left: ${x}%;
                    top: ${y}%;
                    width: ${size}px;
                    height: ${size}px;
                    opacity: ${initialOpacity};
                    --duration: ${duration}s;
                `;
                
                starsContainer.appendChild(star);
            }
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆ›å»ºæ˜Ÿæ˜Ÿ
        window.addEventListener('DOMContentLoaded', () => {
            createStars();
            loadVideos(); // ä¿æŒåŸæœ‰çš„è§†é¢‘åŠ è½½
        });
    </script>

    <!-- åœ¨bodyæ ‡ç­¾ç»“æŸå‰æ·»åŠ é¡µè„š -->
    <footer style="text-align: center; padding: 20px 0; color: #fff; position: relative; z-index: 1;">
        <div id="currentTime" class="rainbow-text" style="margin-bottom: 10px; font-size: 1.2rem;"></div>
        <div class="links">
            <a href="https://github.com/ä½ çš„ç”¨æˆ·å">é¦–é¡µ</a>
            <span class="separator">|</span>
            <a href="https://twitter.com/ä½ çš„ç”¨æˆ·å">ä¸‹ä¸€é¡µ</a>
        </div>
    </footer>

    <script>
        // æ·»åŠ æ—¶é—´æ›´æ–°å‡½æ•°
        function updateTime() {
            const timeElement = document.getElementById('currentTime');
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            timeElement.textContent = timeString;
        }

        // æ¯ç§’æ›´æ–°æ—¶é—´
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>
</html> 